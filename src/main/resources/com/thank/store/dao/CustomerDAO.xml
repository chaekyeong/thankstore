<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thank.store.dao.CustomerDAO">
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/23 16:50
	 -->
	<select id="getCustomerInfo" parameterType="long" resultType="CustomerDTO" >
		select m.no as no,
				c.no as customerno, 
			   m.name as name, 
			   m.accountno as accountno,
			   c.point as point
		from customer c 
		join member m on c.member_no = m.no 
		<!-- join purchaselist p on c.no = p.customer_no -->
		where m.no = #{no}
	</select>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/23 16:50
	 -->
	<select id="getPurchaseCount" parameterType="long" resultType="long">
		select count(*)
		from purchaselist
		where customer_no = #{no}
	</select>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/24 16:20
	 -->
	<select id="searchCvstoreList" parameterType="CusSearchDTO" resultType="CvstoreDTO">
		select B.*
		from (select rownum as rnum, A.*
		      from (select distinct(c.no),
				c.name,
				c.storecode,
				c.latitude,
				c.longitude,
				c.address,
				c.brand
		from cvstore c
		join cvstoreproduct cv on c.no = cv.cvstore_no
		join productlist p on  p.no = cv.productlist_no
		where p.name like '%'||#{searchKeyword}||'%'
		and p.maincategory like '%'||#{mainCategory}||'%'
		and p.subcategory like '%'||#{subCategory}||'%'
		and cv.enrollment = 1
		) A
			  ) B 
		where rnum between #{pagingDTO.startNum} and #{pagingDTO.endNum}
	</select>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/27 12:24
	 -->
	<select id="getTotalRecord" parameterType="CusSearchDTO" resultType="long">
		select count(distinct(c.no)) as cnt
		from cvstore c
		join cvstoreproduct cv on c.no = cv.cvstore_no
		join productlist p on  p.no = cv.productlist_no
		where p.name like '%'||#{searchKeyword}||'%'
		and p.maincategory like '%'||#{mainCategory}||'%'
		and p.subcategory like '%'||#{subCategory}||'%'
		and cv.enrollment = 1
	</select>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/24 16:20
	 -->
	<select id="searchCvsProductList" parameterType="CusSearchDTO" resultType="CvsProductDTO">
		select p.name as name,
				p.no as productcode,
				p.maincategory as maincategory,
				p.subcategory as subcategory,
				p.price as price,
				c.no as no,
				c.enrollment as enrollment,
				c.warehousingdate as warehousingdate,
				c.expirationdate as expirationdate,
				ROUND((sysdate - expirationdate) * 24) as countTime
		from cvstoreproduct c
		join productlist p on c.productlist_no = p.no
		join cvstore cvs on  c.cvstore_no = cvs.no
		where cvs.no = #{cvstore_no}
		and p.name like '%'||#{searchKeyword}||'%'
		and p.maincategory like '%'||#{mainCategory}||'%'
		and p.subcategory like '%'||#{subCategory}||'%'
		and c.enrollment = 1
	</select>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/24 18:40
	 -->
	<update id="rechargePoint" parameterType="CustomerDTO">
		update customer set point = point + #{point}
		where member_no = #{no}
	</update>
	
	<!-- 
	작성자 : 방지훈
	작성일자: 2021/05/25 23:32
	 -->
	<select id="getSubCategory" parameterType="CusSearchDTO" resultType="String">
		select distinct(subcategory)
		from productlist
		where maincategory like '%'||#{mainCategory}||'%'
	</select>
	
	
</mapper>